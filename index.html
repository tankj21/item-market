<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azisaba Auction Viewer</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>Azisaba Auction</h1>
                <p>APIキーを入力してください</p>
            </div>
            <div class="login-form">
                <label for="apiKeyInput">API Key</label>
                <input type="password" id="apiKeyInput" placeholder="api-key を入力">
                <div id="errorMessage" class="error-message hidden"></div>
                <button id="loginBtn" onclick="handleLogin()">ログイン</button>
            </div>
        </div>
    </div>

    <!-- メイン画面 -->
    <div id="mainScreen" class="main-container hidden">
        <div class="content-wrapper">
            <div class="header">
                <div class="header-top">
                    <h1>Azisaba Auction</h1>
                    <button id="refreshBtn" onclick="handleRefresh()" class="refresh-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>
                <div class="header-controls">
                    <div class="search-box">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text" id="searchInput" placeholder="アイテム名または出品者で検索...">
                    </div>
                    <select id="sortSelect" onchange="handleSort()">
                        <option value="time-asc">残り時間: 早い順</option>
                        <option value="time-desc" selected>残り時間: 遅い順</option>
                        <option value="price-low">価格: 安い順</option>
                        <option value="price-high">価格: 高い順</option>
                        <option value="name">アイテム名</option>
                    </select>
                </div>
            </div>

            <div class="content">
                <div id="auctionCount" class="auction-count"></div>
                <div id="loadingMessage" class="loading-message hidden">
                    <svg class="loading-spinner" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    <p>読み込み中...</p>
                </div>
                <div id="emptyMessage" class="empty-message hidden">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    </svg>
                    <p>オークションが見つかりませんでした</p>
                </div>
                <div id="auctionGrid" class="auction-grid"></div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal hidden" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button onclick="closeModal()" class="close-btn">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        let apiKey = '';
        let allAuctions = [];
        let filteredAuctions = [];
        const uuidToMcidCache = {};

        document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            filterAuctions(e.target.value);
        });

        async function handleLogin() {
            const input = document.getElementById('apiKeyInput');
            const btn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('errorMessage');
            
            apiKey = input.value.trim();
            if (!apiKey) return;

            btn.disabled = true;
            btn.textContent = '接続中...';
            errorMsg.classList.add('hidden');

            try {
                await fetchAuctions();
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
            } catch (error) {
                errorMsg.textContent = error.message;
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'ログイン';
            }
        }

        async function fetchAuctions() {
            const loading = document.getElementById('loadingMessage');
            const grid = document.getElementById('auctionGrid');
            
            loading.classList.remove('hidden');
            grid.innerHTML = '';

            try {
                const response = await fetch('https://api-ktor.azisaba.net/servers/life/auctions', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('APIキーが無効か、アクセスに失敗しました');
                }

                const data = await response.json();
                allAuctions = data;
                
                // UUIDからMCIDを取得
                await fetchMcidsForAuctions(data);
                
                const searchTerm = document.getElementById('searchInput').value;
                filterAuctions(searchTerm);

            } catch (error) {
                throw error;
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function fetchMcidsForAuctions(auctions) {
            const uuids = [...new Set(auctions.map(a => a.seller))];
            
            for (const uuid of uuids) {
                if (!uuidToMcidCache[uuid]) {
                    try {
                        const mcid = await uuidToMcid(uuid);
                        uuidToMcidCache[uuid] = mcid;
                    } catch (e) {
                        uuidToMcidCache[uuid] = uuid;
                    }
                }
            }
        }

        async function uuidToMcid(uuid) {
            try {
                const response = await fetch(`https://mojang-proxy.vercel.app/api/profile?uuid=${uuid.replace(/-/g, '')}`);
                if (!response.ok) throw new Error('Failed to fetch');
                const data = await response.json();
                return data.name || uuid;
            } catch (e) {
                return uuid;
            }
        }

        function handleRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            fetchAuctions().finally(() => {
                setTimeout(() => btn.classList.remove('spinning'), 500);
            });
        }

        function filterAuctions(searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredAuctions = allAuctions.filter(auction => {
                const mcid = uuidToMcidCache[auction.seller] || auction.seller;
                return (auction.item_name || '').toLowerCase().includes(term) ||
                       mcid.toLowerCase().includes(term);
            });
            handleSort();
        }

function handleSort() {
            const sortValue = document.getElementById('sortSelect').value;
            
            if (sortValue === 'time-asc') {
                // 残り時間が早い順 = expires_at が小さい順 (昇順)
                filteredAuctions.sort((a, b) => (a.expires_at || 0) - (b.expires_at || 0));
            } else if (sortValue === 'time-desc') {
                // 残り時間が遅い順 = expires_at が大きい順 (降順)
                filteredAuctions.sort((a, b) => (b.expires_at || 0) - (a.expires_at || 0));
            } else if (sortValue === 'price-low') {
                filteredAuctions.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (sortValue === 'price-high') {
                filteredAuctions.sort((a, b) => (b.price || 0) - (a.price || 0));
            } else if (sortValue === 'name') {
                filteredAuctions.sort((a, b) => {
                    const nameA = stripMinecraftColors(a.item_name || '').toLowerCase();
                    const nameB = stripMinecraftColors(b.item_name || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            }
            
            renderAuctions();
        }

        function parseItemBytes(base64Data) {
            try {
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decompressed = pako.ungzip(bytes);
                
                return parseNBT(decompressed);
            } catch (e) {
                console.error('Failed to parse item bytes:', e);
                return null;
            }
        }

        function parseNBT(buffer) {
            let offset = 0;
            
            function readByte() {
                return buffer[offset++];
            }
            
            function readShort() {
                const value = (buffer[offset] << 8) | buffer[offset + 1];
                offset += 2;
                return value;
            }
            
            function readInt() {
                const value = (buffer[offset] << 24) | (buffer[offset + 1] << 16) | 
                             (buffer[offset + 2] << 8) | buffer[offset + 3];
                offset += 4;
                return value;
            }
            
            function readLong() {
                const high = readInt();
                const low = readInt();
                return high * 0x100000000 + low;
            }
            
            function readFloat() {
                const view = new DataView(buffer.buffer, buffer.byteOffset + offset, 4);
                offset += 4;
                return view.getFloat32(0, false);
            }
            
            function readDouble() {
                const view = new DataView(buffer.buffer, buffer.byteOffset + offset, 8);
                offset += 8;
                return view.getFloat64(0, false);
            }
            
            function readString() {
                const length = readShort();
                const str = new TextDecoder('utf-8').decode(buffer.slice(offset, offset + length));
                offset += length;
                return str;
            }
            
            function readByteArray() {
                const length = readInt();
                const arr = Array.from(buffer.slice(offset, offset + length));
                offset += length;
                return arr;
            }
            
            function readIntArray() {
                const length = readInt();
                const arr = [];
                for (let i = 0; i < length; i++) {
                    arr.push(readInt());
                }
                return arr;
            }
            
            function readLongArray() {
                const length = readInt();
                const arr = [];
                for (let i = 0; i < length; i++) {
                    arr.push(readLong());
                }
                return arr;
            }
            
            function readTag(type) {
                switch (type) {
                    case 0: return null; // TAG_End
                    case 1: return readByte(); // TAG_Byte
                    case 2: return readShort(); // TAG_Short
                    case 3: return readInt(); // TAG_Int
                    case 4: return readLong(); // TAG_Long
                    case 5: return readFloat(); // TAG_Float
                    case 6: return readDouble(); // TAG_Double
                    case 7: return readByteArray(); // TAG_Byte_Array
                    case 8: return readString(); // TAG_String
                    case 9: return readList(); // TAG_List
                    case 10: return readCompound(); // TAG_Compound
                    case 11: return readIntArray(); // TAG_Int_Array
                    case 12: return readLongArray(); // TAG_Long_Array
                    default: throw new Error('Unknown tag type: ' + type);
                }
            }
            
            function readList() {
                const type = readByte();
                const length = readInt();
                const list = [];
                for (let i = 0; i < length; i++) {
                    list.push(readTag(type));
                }
                return { type, value: list };
            }
            
            function readCompound() {
                const compound = {};
                while (true) {
                    const type = readByte();
                    if (type === 0) break; // TAG_End
                    const name = readString();
                    compound[name] = readTag(type);
                }
                return compound;
            }
            
            const type = readByte();
            if (type !== 10) throw new Error('Root tag must be TAG_Compound');
            readString(); 
            return readCompound();
        }

        function extractItemInfo(nbtData) {
            if (!nbtData) return null;
            
            const info = {
                enchantments: [],
                attributes: [],
                lore: [],
                displayName: null,
                damage: null,
                unbreakable: false,
                customModelData: null,
                count: 1
            };
            
            try {
                // アイテム数
                if (nbtData.Count !== undefined) {
                    info.count = nbtData.Count;
                }
                
                // タグデータ
                const tag = nbtData.tag;
                if (!tag) return info;
                
                // ダメージ値
                if (tag.Damage !== undefined) {
                    info.damage = tag.Damage;
                }
                
                // 壊れない
                if (tag.Unbreakable !== undefined) {
                    info.unbreakable = tag.Unbreakable === 1;
                }
                
                // カスタムモデルデータ
                if (tag.CustomModelData !== undefined) {
                    info.customModelData = tag.CustomModelData;
                }
                
                // 表示情報
                const display = tag.display;
                if (display) {
                    if (display.Name) {
                        info.displayName = display.Name;
                    }
                    
                    if (display.Lore && display.Lore.value) {
                        info.lore = display.Lore.value;
                    }
                }
                
                // エンチャント
                if (tag.Enchantments && tag.Enchantments.value) {
                    info.enchantments = tag.Enchantments.value.map(ench => ({
                        id: ench.id || 'unknown',
                        level: ench.lvl || 1
                    }));
                }
                
                // 保存されたエンチャント
                if (tag.StoredEnchantments && tag.StoredEnchantments.value) {
                    info.storedEnchantments = tag.StoredEnchantments.value.map(ench => ({
                        id: ench.id || 'unknown',
                        level: ench.lvl || 1
                    }));
                }
                
                // あとりびゅーと
                if (tag.AttributeModifiers && tag.AttributeModifiers.value) {
                    info.attributes = tag.AttributeModifiers.value.map(attr => ({
                        name: attr.AttributeName || attr.Name || 'unknown',
                        amount: attr.Amount || 0,
                        operation: attr.Operation || 0,
                        slot: attr.Slot || 'any'
                    }));
                }
                
            } catch (e) {
                console.error('Error extracting item info:', e);
            }
            
            return info;
        }

        function getEnchantmentName(id) {
            const enchantNames = {
                'minecraft:protection': 'ダメージ軽減',
                'minecraft:fire_protection': '火炎耐性',
                'minecraft:feather_falling': '落下耐性',
                'minecraft:blast_protection': '爆発耐性',
                'minecraft:projectile_protection': '飛び道具耐性',
                'minecraft:respiration': '水中呼吸',
                'minecraft:aqua_affinity': '水中採掘',
                'minecraft:thorns': '棘の鎧',
                'minecraft:depth_strider': '水中歩行',
                'minecraft:frost_walker': '氷渡り',
                'minecraft:sharpness': '鋭さ',
                'minecraft:smite': 'アンデッド特効',
                'minecraft:bane_of_arthropods': '虫特効',
                'minecraft:knockback': 'ノックバック',
                'minecraft:fire_aspect': '火属性',
                'minecraft:looting': 'ドロップ増加',
                'minecraft:sweeping': '範囲ダメージ増加',
                'minecraft:efficiency': '効率強化',
                'minecraft:silk_touch': 'シルクタッチ',
                'minecraft:unbreaking': '耐久力',
                'minecraft:fortune': '幸運',
                'minecraft:power': 'パワー',
                'minecraft:punch': '衝撃',
                'minecraft:flame': 'フレイム',
                'minecraft:infinity': '無限',
                'minecraft:luck_of_the_sea': '宝釣り',
                'minecraft:lure': '入れ食い',
                'minecraft:mending': '修繕',
                'minecraft:vanishing_curse': '消滅の呪い',
                'minecraft:binding_curse': '束縛の呪い'
            };
            return enchantNames[id] || id.replace('minecraft:', '');
        }

        function getAttributeName(name) {
            const attrNames = {
                'generic.maxHealth': '最大体力',
                'generic.followRange': '索敵範囲',
                'generic.knockbackResistance': 'ノックバック耐性',
                'generic.movementSpeed': '移動速度',
                'generic.attackDamage': '攻撃力',
                'generic.attackSpeed': '攻撃速度',
                'generic.armor': '防御力',
                'generic.armorToughness': '防具強度',
                'generic.luck': '運'
            };
            return attrNames[name] || name.replace('generic.', '').replace('_', ' ');
        }

        function stripMinecraftColors(text) {
            if (!text) return '';
            return text.replace(/§[0-9a-fk-or]/gi, '');
        }

        function renderMinecraftText(text) {
            if (!text) return '';
            
            const colorMap = {
                '0': '#000000', '1': '#0000AA', '2': '#00AA00', '3': '#00AAAA',
                '4': '#AA0000', '5': '#AA00AA', '6': '#FFAA00', '7': '#AAAAAA',
                '8': '#555555', '9': '#5555FF', 'a': '#55FF55', 'b': '#55FFFF',
                'c': '#FF5555', 'd': '#FF55FF', 'e': '#FFFF55', 'f': '#FFFFFF',
                'l': 'bold', 'o': 'italic'
            };
            
            let html = '';
            let currentStyles = [];
            const parts = text.split('§');
            
            for (let i = 0; i < parts.length; i++) {
                if (i === 0) {
                    html += parts[i];
                    continue;
                }
                
                const code = parts[i][0];
                const content = parts[i].substring(1);
                
                if (colorMap[code]) {
                    if (code === 'l') {
                        html += `<strong>${content}`;
                        currentStyles.push('strong');
                    } else if (code === 'o') {
                        html += `<em>${content}`;
                        currentStyles.push('em');
                    } else {
                        html += `<span style="color: ${colorMap[code]}">${content}</span>`;
                    }
                } else {
                    html += content;
                }
            }
            
            // Close any open tags
            while (currentStyles.length > 0) {
                const tag = currentStyles.pop();
                html += `</${tag}>`;
            }
            
            return html;
        }

        function showDetail(auction) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = stripMinecraftColors(auction.item_name);
            
            const mcid = uuidToMcidCache[auction.seller] || auction.seller;
            const nbtData = auction.item_bytes ? parseItemBytes(auction.item_bytes) : null;
            const itemInfo = nbtData ? extractItemInfo(nbtData) : null;
            
            let detailHtml = `
                <div class="detail-section">
                    <h3>基本情報</h3>
                    <div class="detail-row">
                        <span class="detail-label">アイテム名:</span>
                        <span class="mc-text">${renderMinecraftText(auction.item_name)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">価格:</span>
                        <span class="price-text">¥${formatPrice(auction.price)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">出品者:</span>
                        <span>${mcid}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Store ID:</span>
                        <span>${auction.store_id}</span>
                    </div>
                    ${itemInfo && itemInfo.count > 1 ? `
                    <div class="detail-row">
                        <span class="detail-label">個数:</span>
                        <span>${itemInfo.count}</span>
                    </div>
                    ` : ''}
                    <div class="detail-row">
                        <span class="detail-label">入札可能:</span>
                        <span>${auction.biddable ? 'はい' : 'いいえ'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">期限:</span>
                        <span>${formatTime(auction.expires_at)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">削除予定:</span>
                        <span>${formatTime(auction.time_till_data_removal)}</span>
                    </div>
                </div>
            `;
            
            if (auction.item_lore) {
                detailHtml += `
                    <div class="detail-section">
                        <h3>説明</h3>
                        <div class="lore-text mc-text">
                            ${auction.item_lore.split('\n').map(line => renderMinecraftText(line)).join('<br>')}
                        </div>
                    </div>
                `;
            }
            
            if (itemInfo) {
                // エンチャント
                if (itemInfo.enchantments && itemInfo.enchantments.length > 0) {
                    detailHtml += `
                        <div class="detail-section">
                            <h3>エンチャント</h3>
                            <div class="enchant-list">
                                ${itemInfo.enchantments.map(ench => `
                                    <div class="enchant-item">
                                        <span class="enchant-name">${getEnchantmentName(ench.id)}</span>
                                        <span class="enchant-level">Lv.${ench.level}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // 保存されたエンチャント
                if (itemInfo.storedEnchantments && itemInfo.storedEnchantments.length > 0) {
                    detailHtml += `
                        <div class="detail-section">
                            <h3>保存されたエンチャント</h3>
                            <div class="enchant-list">
                                ${itemInfo.storedEnchantments.map(ench => `
                                    <div class="enchant-item">
                                        <span class="enchant-name">${getEnchantmentName(ench.id)}</span>
                                        <span class="enchant-level">Lv.${ench.level}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // 属性
                if (itemInfo.attributes && itemInfo.attributes.length > 0) {
                    // スロットごとに属性を分類
                    const attributesBySlot = {};
                    itemInfo.attributes.forEach(attr => {
                        const slot = attr.slot || 'any';
                        if (!attributesBySlot[slot]) {
                            attributesBySlot[slot] = [];
                        }
                        attributesBySlot[slot].push(attr);
                    });
                    
                    const slotNames = {
                        'mainhand': 'メインハンド',
                        'offhand': 'オフハンド',
                        'head': '頭',
                        'chest': '胴体',
                        'legs': '脚',
                        'feet': '足',
                        'any': '全スロット'
                    };
                    
                    detailHtml += `<div class="detail-section"><h3>属性</h3>`;
                    
                    Object.keys(attributesBySlot).forEach(slot => {
                        const attrs = attributesBySlot[slot];
                        const slotName = slotNames[slot] || slot;
                        
                        if (Object.keys(attributesBySlot).length > 1) {
                            detailHtml += `<div class="attribute-category">${slotName}:</div>`;
                        }
                        
                        detailHtml += `<div class="attribute-simple-list">`;
                        attrs.forEach(attr => {
                            const name = getAttributeName(attr.name);
                            let displayValue = '';
                            
                            // 小数点2桁まで表示（切り捨て）
                            const truncate = (num) => Math.floor(num * 100) / 100;
                            
                            // 操作タイプに応じた表示
                            if (attr.operation === 0) {
                                // 加算
                                const sign = attr.amount >= 0 ? '+' : '';
                                displayValue = `${sign}${truncate(attr.amount)}`;
                            } else if (attr.operation === 1) {
                                // 乗算（基礎値）
                                const percent = truncate(attr.amount * 100);
                                displayValue = `+${percent}%`;
                            } else if (attr.operation === 2) {
                                // 乗算（合計値）
                                displayValue = `×${truncate(1 + attr.amount)}`;
                            }
                            
                            detailHtml += `
                                <div class="attribute-simple-item">
                                    ${name} ${displayValue}
                                </div>
                            `;
                        });
                        detailHtml += `</div>`;
                    });
                    
                    detailHtml += `</div>`;
                }
                
                // その他の情報
                const otherInfo = [];
                if (itemInfo.unbreakable) otherInfo.push('不可壊');
                if (itemInfo.damage !== null) otherInfo.push(`ダメージ: ${itemInfo.damage}`);
                if (itemInfo.customModelData !== null) otherInfo.push(`カスタムモデル: ${itemInfo.customModelData}`);
                
                if (otherInfo.length > 0) {
                    detailHtml += `
                        <div class="detail-section">
                            <h3>その他</h3>
                            <div class="other-info">
                                ${otherInfo.map(info => `<span class="info-badge">${info}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            body.innerHTML = detailHtml;
            modal.classList.remove('hidden');
        }

        function closeModal(event) {
            const modal = document.getElementById('detailModal');
            modal.classList.add('hidden');
        }

        function renderAuctions() {
            const grid = document.getElementById('auctionGrid');
            const emptyMsg = document.getElementById('emptyMessage');
            const countMsg = document.getElementById('auctionCount');

            countMsg.textContent = `${filteredAuctions.length} 件のオークション`;

            if (filteredAuctions.length === 0) {
                grid.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');
            grid.innerHTML = filteredAuctions.map((auction, index) => {
                const mcid = uuidToMcidCache[auction.seller] || auction.seller;
                const expiresIn = auction.expires_at ? Math.max(0, auction.expires_at - Date.now()) : 0;
                const hours = Math.floor(expiresIn / 3600000);
                const minutes = Math.floor((expiresIn % 3600000) / 60000);
                
                return `
                    <div class="auction-card" onclick="showDetail(allAuctions[${allAuctions.indexOf(auction)}])">
                        <div class="auction-header">
                            <h3 class="mc-text">${renderMinecraftText(auction.item_name)}</h3>
                            <span class="auction-id">#${auction.store_id || index}</span>
                        </div>
                        <div class="auction-details">
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <span class="label">出品者:</span>
                                <span>${mcid}</span>
                            </div>
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span class="label">残り時間:</span>
                                <span class="time">${hours}時間${minutes}分</span>
                            </div>
                            ${auction.biddable ? `
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                                <span class="label">入札可能</span>
                            </div>
                            ` : ''}
                            <div class="price-section">
                                <span class="price-label">価格</span>
                                <span class="price-value">¥${formatPrice(auction.price)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('ja-JP');
        }

        function formatPrice(price) {
            return (price || 0).toLocaleString();
        }
    </script>
</body>
</html>

