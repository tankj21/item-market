<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azisaba Auction Viewer</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>Azisaba Auction</h1>
                <p>APIキーを入力してください</p>
            </div>
            <div class="login-form">
                <label for="apiKeyInput">API Key</label>
                <input type="password" id="apiKeyInput" placeholder="api-key を入力">
                <div id="errorMessage" class="error-message hidden"></div>
                <button id="loginBtn" onclick="handleLogin()">ログイン</button>
            </div>
        </div>
    </div>

    <!-- メイン画面 -->
    <div id="mainScreen" class="main-container hidden">
        <div class="content-wrapper">
            <div class="header">
                <div class="header-top">
                    <h1>Azisaba Auction</h1>
                    <button id="refreshBtn" onclick="handleRefresh()" class="refresh-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>
                <div class="header-controls">
                    <div class="search-box">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text" id="searchInput" placeholder="アイテム名または出品者で検索...">
                    </div>
                    <select id="sortSelect" onchange="handleSort()">
                        <option value="time">最新順</option>
                        <option value="price-low">価格: 安い順</option>
                        <option value="price-high">価格: 高い順</option>
                    </select>
                </div>
            </div>

            <div class="content">
                <div id="auctionCount" class="auction-count"></div>
                <div id="loadingMessage" class="loading-message hidden">
                    <svg class="loading-spinner" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    <p>読み込み中...</p>
                </div>
                <div id="emptyMessage" class="empty-message hidden">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    </svg>
                    <p>オークションが見つかりませんでした</p>
                </div>
                <div id="auctionGrid" class="auction-grid"></div>
            </div>
        </div>
    </div>

    <!-- 詳細モーダル -->
    <div id="detailModal" class="modal hidden" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button onclick="closeModal()" class="close-btn">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        let apiKey = '';
        let allAuctions = [];
        let filteredAuctions = [];
        const uuidToMcidCache = {};

        document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            filterAuctions(e.target.value);
        });

        async function handleLogin() {
            const input = document.getElementById('apiKeyInput');
            const btn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('errorMessage');
            
            apiKey = input.value.trim();
            if (!apiKey) return;

            btn.disabled = true;
            btn.textContent = '接続中...';
            errorMsg.classList.add('hidden');

            try {
                await fetchAuctions();
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
            } catch (error) {
                errorMsg.textContent = error.message;
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'ログイン';
            }
        }

        async function fetchAuctions() {
            const loading = document.getElementById('loadingMessage');
            const grid = document.getElementById('auctionGrid');
            
            loading.classList.remove('hidden');
            grid.innerHTML = '';

            try {
                const response = await fetch('https://api-ktor.azisaba.net/servers/life/auctions', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('APIキーが無効か、アクセスに失敗しました');
                }

                const data = await response.json();
                allAuctions = data;
                filteredAuctions = [...data];
                
                // UUIDからMCIDを取得
                await fetchMcidsForAuctions(data);
                
                renderAuctions();
            } catch (error) {
                throw error;
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function fetchMcidsForAuctions(auctions) {
            const uuids = [...new Set(auctions.map(a => a.seller))];
            
            for (const uuid of uuids) {
                if (!uuidToMcidCache[uuid]) {
                    try {
                        const mcid = await uuidToMcid(uuid);
                        uuidToMcidCache[uuid] = mcid;
                    } catch (e) {
                        uuidToMcidCache[uuid] = uuid;
                    }
                }
            }
        }

        async function uuidToMcid(uuid) {
            try {
                const response = await fetch(`https://mojang-proxy.vercel.app/api/profile?uuid=${uuid.replace(/-/g, '')}`);
                if (!response.ok) throw new Error('Failed to fetch');
                const data = await response.json();
                return data.name || uuid;
            } catch (e) {
                return uuid;
            }
        }

        function handleRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            fetchAuctions().finally(() => {
                setTimeout(() => btn.classList.remove('spinning'), 500);
            });
        }

        function filterAuctions(searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredAuctions = allAuctions.filter(auction => {
                const mcid = uuidToMcidCache[auction.seller] || auction.seller;
                return (auction.item_name || '').toLowerCase().includes(term) ||
                       mcid.toLowerCase().includes(term);
            });
            handleSort();
        }

        function handleSort() {
            const sortValue = document.getElementById('sortSelect').value;
            
            if (sortValue === 'price-low') {
                filteredAuctions.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (sortValue === 'price-high') {
                filteredAuctions.sort((a, b) => (b.price || 0) - (a.price || 0));
            } else {
                filteredAuctions.sort((a, b) => (b.expires_at || 0) - (a.expires_at || 0));
            }
            
            renderAuctions();
        }

        function parseItemBytes(base64Data) {
            try {
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decompressed = pako.ungzip(bytes);
                return parseNBT(decompressed);
            } catch (e) {
                console.error('Failed to parse item bytes:', e);
                return null;
            }
        }

        function parseNBT(data) {
            // 簡易的なNBTパース（完全な実装ではありません）
            const result = {};
            try {
                const view = new DataView(data.buffer);
                let offset = 0;
                
                // NBTデータの解析は複雑なため、基本的な情報のみ抽出
                result.rawData = Array.from(data.slice(0, Math.min(100, data.length)));
                result.size = data.length;
            } catch (e) {
                console.error('NBT parse error:', e);
            }
            return result;
        }

        function stripMinecraftColors(text) {
            if (!text) return '';
            return text.replace(/§[0-9a-fk-or]/gi, '');
        }

        function renderMinecraftText(text) {
            if (!text) return '';
            
            const colorMap = {
                '0': '#000000', '1': '#0000AA', '2': '#00AA00', '3': '#00AAAA',
                '4': '#AA0000', '5': '#AA00AA', '6': '#FFAA00', '7': '#AAAAAA',
                '8': '#555555', '9': '#5555FF', 'a': '#55FF55', 'b': '#55FFFF',
                'c': '#FF5555', 'd': '#FF55FF', 'e': '#FFFF55', 'f': '#FFFFFF',
                'l': 'bold', 'o': 'italic'
            };
            
            let html = '';
            let currentStyles = [];
            const parts = text.split('§');
            
            for (let i = 0; i < parts.length; i++) {
                if (i === 0) {
                    html += parts[i];
                    continue;
                }
                
                const code = parts[i][0];
                const content = parts[i].substring(1);
                
                if (colorMap[code]) {
                    if (code === 'l') {
                        html += `<strong>${content}`;
                        currentStyles.push('strong');
                    } else if (code === 'o') {
                        html += `<em>${content}`;
                        currentStyles.push('em');
                    } else {
                        html += `<span style="color: ${colorMap[code]}">${content}</span>`;
                    }
                } else {
                    html += content;
                }
            }
            
            // Close any open tags
            while (currentStyles.length > 0) {
                const tag = currentStyles.pop();
                html += `</${tag}>`;
            }
            
            return html;
        }

        function showDetail(auction) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = stripMinecraftColors(auction.item_name);
            
            const mcid = uuidToMcidCache[auction.seller] || auction.seller;
            const nbtData = auction.item_bytes ? parseItemBytes(auction.item_bytes) : null;
            
            let detailHtml = `
                <div class="detail-section">
                    <h3>基本情報</h3>
                    <div class="detail-row">
                        <span class="detail-label">アイテム名:</span>
                        <span class="mc-text">${renderMinecraftText(auction.item_name)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">価格:</span>
                        <span class="price-text">¥${formatPrice(auction.price)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">出品者:</span>
                        <span>${mcid}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Store ID:</span>
                        <span>${auction.store_id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">入札可能:</span>
                        <span>${auction.biddable ? 'はい' : 'いいえ'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">期限:</span>
                        <span>${formatTime(auction.expires_at)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">削除予定:</span>
                        <span>${formatTime(auction.time_till_data_removal)}</span>
                    </div>
                </div>
            `;
            
            if (auction.item_lore) {
                detailHtml += `
                    <div class="detail-section">
                        <h3>説明</h3>
                        <div class="lore-text mc-text">
                            ${auction.item_lore.split('\n').map(line => renderMinecraftText(line)).join('<br>')}
                        </div>
                    </div>
                `;
            }
            
            if (nbtData) {
                detailHtml += `
                    <div class="detail-section">
                        <h3>NBTデータ</h3>
                        <div class="detail-row">
                            <span class="detail-label">データサイズ:</span>
                            <span>${nbtData.size} bytes</span>
                        </div>
                        <div class="nbt-info">
                            <p class="text-muted">※ NBTデータの完全な解析には専用パーサーが必要です</p>
                        </div>
                    </div>
                `;
            }
            
            body.innerHTML = detailHtml;
            modal.classList.remove('hidden');
        }

        function closeModal(event) {
            const modal = document.getElementById('detailModal');
            modal.classList.add('hidden');
        }

        function renderAuctions() {
            const grid = document.getElementById('auctionGrid');
            const emptyMsg = document.getElementById('emptyMessage');
            const countMsg = document.getElementById('auctionCount');

            countMsg.textContent = `${filteredAuctions.length} 件のオークション`;

            if (filteredAuctions.length === 0) {
                grid.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');
            grid.innerHTML = filteredAuctions.map((auction, index) => {
                const mcid = uuidToMcidCache[auction.seller] || auction.seller;
                const expiresIn = auction.expires_at ? Math.max(0, auction.expires_at - Date.now()) : 0;
                const hours = Math.floor(expiresIn / 3600000);
                const minutes = Math.floor((expiresIn % 3600000) / 60000);
                
                return `
                    <div class="auction-card" onclick="showDetail(allAuctions[${allAuctions.indexOf(auction)}])">
                        <div class="auction-header">
                            <h3 class="mc-text">${renderMinecraftText(auction.item_name)}</h3>
                            <span class="auction-id">#${auction.store_id || index}</span>
                        </div>
                        <div class="auction-details">
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <span class="label">出品者:</span>
                                <span>${mcid}</span>
                            </div>
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span class="label">残り時間:</span>
                                <span class="time">${hours}時間${minutes}分</span>
                            </div>
                            ${auction.biddable ? `
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                </svg>
                                <span class="label">入札可能</span>
                            </div>
                            ` : ''}
                            <div class="price-section">
                                <span class="price-label">価格</span>
                                <span class="price-value">¥${formatPrice(auction.price)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('ja-JP');
        }

        function formatPrice(price) {
            return (price || 0).toLocaleString();
        }
    </script>
</body>
</html>

